#!/usr/bin/env node
const fs = require('fs')
const { execSync } = require('child_process')
const pwd = execSync('pwd').toString().trim() + '/'
const filename = __filename.replace(pwd, '')

const parseExample = categoryLabel => example => {
  let [ title, ...rest ] = example.trim().split('\n')
  title = title.trim().replace(/^#\s*/, '')
  const query = rest.join('\n').trim()
  return { title, query, category: categoryLabel, tags: [] }
}

const getCategoryExamples = categoryFilename => {
  const lines = fs.readFileSync(`./scripts/assets/InventaireQueryExamples/${categoryFilename}`)
    .toString()
    .split('\n')

  const categoryLabel = lines.shift().replace(/^#\s*/, '')

  return lines.join('\n')
  .split('###')
  .map(parseExample(categoryLabel))
}

const examples = fs.readdirSync('scripts/assets/InventaireQueryExamples')
  .map(getCategoryExamples)

const flattenExamples = [].concat(...examples)

const js = `// Generated by ${filename}
window.invExamples = ${JSON.stringify(flattenExamples, null, 2)};
`

fs.writeFileSync('./wikibase/InventaireQueryExamples.js', js)
